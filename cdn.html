<script>
  // ‚ö° –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –û–ë–ù–û–í–õ–ï–ù–ò–ï–ú CSS
  ;(function () {
    let useLocal = true
    let lastJsTime = 0
    let lastCssTime = 0
    let cssVersion = 0

    function load() {
      const host = useLocal ? "http://localhost:5501" : "https://khrustalev-creative.github.io/git-templates"

      const t = Date.now()

      // CSS - –¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é
      cssVersion++
      const css = document.createElement("link")
      css.rel = "stylesheet"
      css.href = `${host}/styles.css?t=${t}&v=${cssVersion}`
      css.dataset.version = cssVersion
      css.onerror = () => {
        useLocal = false
        load()
      }
      document.head.appendChild(css)

      // JS
      const js = document.createElement("script")
      js.src = `${host}/app.js?t=${t}`
      js.onerror = () => {
        useLocal = false
        load()
      }
      document.head.appendChild(js)

      console.log(useLocal ? "üì° –õ–æ–∫–∞–ª—å–Ω—ã–π" : "üåê GitHub")
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CSS (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    function updateCSS(host) {
      cssVersion++
      const t = Date.now()

      // –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ —Å —ç—Ç–æ–≥–æ —Ö–æ—Å—Ç–∞
      document.querySelectorAll(`link[href*="${host}"]`).forEach((link) => {
        if (link.href.includes("styles.css")) {
          link.remove()
        }
      })

      // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ
      const newCss = document.createElement("link")
      newCss.rel = "stylesheet"
      newCss.href = `${host}/styles.css?t=${t}&v=${cssVersion}`
      newCss.dataset.version = cssVersion
      document.head.appendChild(newCss)

      console.log("üé® CSS –æ–±–Ω–æ–≤–ª–µ–Ω")
    }

    // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    setInterval(async () => {
      try {
        const host = useLocal ? "http://localhost:5501" : "https://khrustalev-creative.github.io/git-templates"

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
        const [jsRes, cssRes] = await Promise.all([
          fetch(`${host}/app.js?check=${Date.now()}`),
          fetch(`${host}/styles.css?check=${Date.now()}`),
        ])

        const jsTime = new Date(jsRes.headers.get("last-modified")).getTime()
        const cssTime = new Date(cssRes.headers.get("last-modified")).getTime()

        // –ï—Å–ª–∏ JS –∏–∑–º–µ–Ω–∏–ª—Å—è - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
        if (lastJsTime && jsTime > lastJsTime) {
          console.log("üîÑ JS –∏–∑–º–µ–Ω–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é...")
          window.location.reload()
          return
        }

        // –ï—Å–ª–∏ CSS –∏–∑–º–µ–Ω–∏–ª—Å—è - –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∏–ª–∏
        if (lastCssTime && cssTime > lastCssTime) {
          console.log("üé® CSS –∏–∑–º–µ–Ω–µ–Ω, –æ–±–Ω–æ–≤–ª—è—é...")
          updateCSS(host)
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        lastJsTime = jsTime || lastJsTime
        lastCssTime = cssTime || lastCssTime
      } catch {
        useLocal = false
      }
    }, 300) // –ß–∞—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º - 300ms

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    load()
  })()
</script>
